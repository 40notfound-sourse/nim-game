<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ニムゲーム</title>
  <style>
    body {
      font-family: "Segoe UI", sans-serif;
      text-align: center;
      background: #f7f7f7;
    }
    h1 { color: #333; }
    .setup {
      margin: 50px auto;
      padding: 50px;
    }
    h2 { color: #333; }
    .setup {
      margin: 20px auto;
      padding: 20px;
    }
    input {
      width: 150px;
      text-align: center;
    }
    button {
      padding: 10px 30px;
      margin-top: 5px;
      cursor: pointer;
      border-radius: 8px;
      border: none;
      background: #0078d7;
      color: white;
      transition: background 0.2s;
    }
    button:hover {
      background: #005fa3;
    }
    .pile {
      margin: 10px;
    }
    .stone {
      display: inline-block;
      width: 50px;
      height: 50px;
      border-radius: 70%;
      background-color: #ff6b6b;
      margin: 10px;
      cursor: pointer;
      transition: transform 10s;
    }
    .stone:hover {
      transform: scale(1.2);
      background-color: #ff4444;
    }
  </style>
</head>
<body>
  <h1>ニムゲーム</h1>

  <div class="setup">
    <label>山の数: <input id="pileCount" type="number" value="3" min="1"></label><br>
    <label>各山の初期石数（カンマ区切り）:<input id="pileSizes" type="text" value="3,4,5"></label><br>
    <label><input type="radio" name="firstTurn" value="player" checked>あなたが先攻</label>
    <label><input type="radio" name="firstTurn" value="computer">コンピュータが先攻</label><br>
    <button onclick="startGame()">ゲーム開始</button>
  </div>

  <h2 id="message">設定を入力してゲームを始めよう！</h2>
  <div id="gameArea"></div>

  <script>
    let piles = [];
    let playerTurn = true;

    function startGame() {
      const count = parseInt(document.getElementById("pileCount").value);
      const sizes = document.getElementById("pileSizes").value
        .split(",")  .map(s => parseInt(s.trim()));

      if (sizes.length !== count || sizes.some(isNaN)) {
        alert("山の数と石数の入力が一致していません。");
        return;
      }

      piles = sizes;
      const turn =document.querySelector('input[name="firstTurn"]:checked').value;
      playerTurn = (turn==="player");

      document.getElementById("message").innerText = playerTurn ? "あなたの番です。" : "コンピュータの番です。";
      render();
      if (!playerTurn) {
        setTimeout(computerMove, 3000);
    }
    }

    function render() {
      const area = document.getElementById("gameArea");
      area.innerHTML = "";

      piles.forEach((count, i) => {
        const pileDiv = document.createElement("div");
        pileDiv.className = "pile";

        const label = document.createElement("div");
        label.innerText = "山 " + (i + 1) + "（" + count + " 個）";
        pileDiv.appendChild(label);

        for (let j = 0; j < count; j++) {
          const stone = document.createElement("div");
          stone.className = "stone";
          stone.onclick = () => handlePlayerMove(i, count - j);
          pileDiv.appendChild(stone);
        }

        area.appendChild(pileDiv);
      });
    }

    function handlePlayerMove(pileIndex, removeCount) {
      if (!playerTurn) return;
      if (piles[pileIndex] < removeCount) return;

      piles[pileIndex] -= removeCount;
      playerTurn = false;
      render();

      if (isGameOver()) {
        document.getElementById("message").innerText = "あなたの勝ち！🎉";
        return;
      }

      document.getElementById("message").innerText = "コンピュータの番です…";
      setTimeout(computerMove, 2000);
    }

    function computerMove() {
      let xorSum = piles.reduce((a, b) => a ^ b, 0);
      let pileIndex = -1;
      let removeCount = 0;

      for (let i = 0; i < piles.length; i++) {
        let target = piles[i] ^ xorSum;
        if (target < piles[i]) {
          pileIndex = i;
          removeCount = piles[i] - target;
          break;
        }
      }

      // 勝ち手がない場合は適当に1個取る
      if (pileIndex === -1) {
        pileIndex = piles.findIndex(p => p > 0);
        removeCount = 1;
      }

      piles[pileIndex] -= removeCount;
      render();

      if (isGameOver()) {
        document.getElementById("message").innerText = "コンピュータの勝ち！🤖";
        return;
      }

      playerTurn = true;
      document.getElementById("message").innerText = "あなたの番です。";
    }

    function isGameOver() {
      return piles.every(p => p === 0);
    }
  </script>
</body>
</html>
